<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UAF-Plankline: classification Namespace Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">UAF-Plankline
   &#160;<span id="projectnumber">v1.0</span>
   </div>
   <div id="projectbrief">THe UAF implementation of OSU&#39;s Plankline image processing system</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">classification Namespace Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a058b4a55f59dd39b4354f2c7767a442f"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceclassification.html#a058b4a55f59dd39b4354f2c7767a442f">classify</a> (tar_file)</td></tr>
<tr class="separator:a058b4a55f59dd39b4354f2c7767a442f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ae2265a284d29baac430805c14061546e"><td class="memItemLeft" align="right" valign="top"><a id="ae2265a284d29baac430805c14061546e"></a>
string&#160;</td><td class="memItemRight" valign="bottom"><b>v_string</b> = &quot;V2023.09.05&quot;</td></tr>
<tr class="separator:ae2265a284d29baac430805c14061546e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a651a4c8526c4529950ca7d0dbea24e67"><td class="memItemLeft" align="right" valign="top"><a id="a651a4c8526c4529950ca7d0dbea24e67"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>parser</b> = argparse.ArgumentParser(description=&quot;Classification tool for managing the isiis_scnn processes&quot;)</td></tr>
<tr class="separator:a651a4c8526c4529950ca7d0dbea24e67"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a06684e2874bbaa1cc7cd29e3ddc4198a"><td class="memItemLeft" align="right" valign="top"><a id="a06684e2874bbaa1cc7cd29e3ddc4198a"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>required</b></td></tr>
<tr class="separator:a06684e2874bbaa1cc7cd29e3ddc4198a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae6dc7ce8935d3fcf14edb10c1bc9e7fe"><td class="memItemLeft" align="right" valign="top"><a id="ae6dc7ce8935d3fcf14edb10c1bc9e7fe"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>True</b></td></tr>
<tr class="separator:ae6dc7ce8935d3fcf14edb10c1bc9e7fe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3f142d2a76666ece7da2bdb77ef1ea84"><td class="memItemLeft" align="right" valign="top"><a id="a3f142d2a76666ece7da2bdb77ef1ea84"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>help</b></td></tr>
<tr class="separator:a3f142d2a76666ece7da2bdb77ef1ea84"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad069a906cefb0ac532b6d74b8d45e516"><td class="memItemLeft" align="right" valign="top"><a id="ad069a906cefb0ac532b6d74b8d45e516"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>args</b> = parser.parse_args()</td></tr>
<tr class="separator:ad069a906cefb0ac532b6d74b8d45e516"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a00558417f6555f880d44eeafc433a72f"><td class="memItemLeft" align="right" valign="top"><a id="a00558417f6555f880d44eeafc433a72f"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>config</b> = configparser.ConfigParser()</td></tr>
<tr class="separator:a00558417f6555f880d44eeafc433a72f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8eb4e9f2063f2c467404bc42fe6b7dde"><td class="memItemLeft" align="right" valign="top"><a id="a8eb4e9f2063f2c467404bc42fe6b7dde"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>working_dir</b> = os.path.abspath(args.directory)</td></tr>
<tr class="separator:a8eb4e9f2063f2c467404bc42fe6b7dde"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a743a8cf0bc5e968b1e015c7ecd541248"><td class="memItemLeft" align="right" valign="top"><a id="a743a8cf0bc5e968b1e015c7ecd541248"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>defaults</b></td></tr>
<tr class="separator:a743a8cf0bc5e968b1e015c7ecd541248"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a895f7955534d1b14e57b377bd1a4bdce"><td class="memItemLeft" align="right" valign="top"><a id="a895f7955534d1b14e57b377bd1a4bdce"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>logger</b> = logging.getLogger('sLogger')</td></tr>
<tr class="separator:a895f7955534d1b14e57b377bd1a4bdce"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a960ac7b28fea5d7c36977c80a072491a"><td class="memItemLeft" align="right" valign="top"><a id="a960ac7b28fea5d7c36977c80a072491a"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>permis</b> = int(config['general']['dir_permissions'])</td></tr>
<tr class="separator:a960ac7b28fea5d7c36977c80a072491a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a378dc8a47071a0d811a2ed2059fc7d75"><td class="memItemLeft" align="right" valign="top"><a id="a378dc8a47071a0d811a2ed2059fc7d75"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>scnn_instances</b> = int(config['classification']['scnn_instances'])</td></tr>
<tr class="separator:a378dc8a47071a0d811a2ed2059fc7d75"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a284c210e2900de514c46c1e6c9a4f8f0"><td class="memItemLeft" align="right" valign="top"><a id="a284c210e2900de514c46c1e6c9a4f8f0"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>scnn_directory</b> = config['classification']['scnn_dir']</td></tr>
<tr class="separator:a284c210e2900de514c46c1e6c9a4f8f0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6a576b579ee6bdc32803b243911b27c4"><td class="memItemLeft" align="right" valign="top"><a id="a6a576b579ee6bdc32803b243911b27c4"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>scnn_command</b> = config['classification']['scnn_cmd']</td></tr>
<tr class="separator:a6a576b579ee6bdc32803b243911b27c4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a10c85806aa750d1defd0a215fd3cd793"><td class="memItemLeft" align="right" valign="top"><a id="a10c85806aa750d1defd0a215fd3cd793"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>epoch</b> = int(config['classification']['epoch'])</td></tr>
<tr class="separator:a10c85806aa750d1defd0a215fd3cd793"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9a342cf0af17f11dff944e089c7561dd"><td class="memItemLeft" align="right" valign="top"><a id="a9a342cf0af17f11dff944e089c7561dd"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>fast_scratch</b> = config['segmentation']['fast_scratch']</td></tr>
<tr class="separator:a9a342cf0af17f11dff944e089c7561dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2a6969214214b326598ca81dc4f27f0d"><td class="memItemLeft" align="right" valign="top"><a id="a2a6969214214b326598ca81dc4f27f0d"></a>
string&#160;</td><td class="memItemRight" valign="bottom"><b>segmentation_dir</b> = working_dir + &quot;/segmentation&quot;</td></tr>
<tr class="separator:a2a6969214214b326598ca81dc4f27f0d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abc630b0e77ae44cdd2e40d7f9d63cda3"><td class="memItemLeft" align="right" valign="top"><a id="abc630b0e77ae44cdd2e40d7f9d63cda3"></a>
string&#160;</td><td class="memItemRight" valign="bottom"><b>classification_dir</b> = working_dir + &quot;/classification&quot;</td></tr>
<tr class="separator:abc630b0e77ae44cdd2e40d7f9d63cda3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa8051090fc5bba242d0579cbb59f158b"><td class="memItemLeft" align="right" valign="top"><a id="aa8051090fc5bba242d0579cbb59f158b"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>exist_ok</b></td></tr>
<tr class="separator:aa8051090fc5bba242d0579cbb59f158b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a84b303452b3c32de0466c38ea7a54f40"><td class="memItemLeft" align="right" valign="top"><a id="a84b303452b3c32de0466c38ea7a54f40"></a>
list&#160;</td><td class="memItemRight" valign="bottom"><b>tars</b> = [os.path.join(segmentation_dir, tar) for tar in os.listdir(segmentation_dir) if tar.endswith(&quot;.tar.gz&quot;)]</td></tr>
<tr class="separator:a84b303452b3c32de0466c38ea7a54f40"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a55b48bee4ddc6cf7848f891a23bedf12"><td class="memItemLeft" align="right" valign="top"><a id="a55b48bee4ddc6cf7848f891a23bedf12"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>num_gpus</b> = str(subprocess.check_output([&quot;nvidia-smi&quot;, &quot;-L&quot;])).count('UUID')</td></tr>
<tr class="separator:a55b48bee4ddc6cf7848f891a23bedf12"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae16bce33b224ec95ee26b50a4f7da476"><td class="memItemLeft" align="right" valign="top"><a id="ae16bce33b224ec95ee26b50a4f7da476"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>queue</b> = Queue()</td></tr>
<tr class="separator:ae16bce33b224ec95ee26b50a4f7da476"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aae64eec8bd4049637f8665759fc3439d"><td class="memItemLeft" align="right" valign="top"><a id="aae64eec8bd4049637f8665759fc3439d"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>num_processes</b> = scnn_instances * num_gpus</td></tr>
<tr class="separator:aae64eec8bd4049637f8665759fc3439d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5f2f1b92a3e77bc8ab16df5dd055f8d0"><td class="memItemLeft" align="right" valign="top"><a id="a5f2f1b92a3e77bc8ab16df5dd055f8d0"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>tar_length</b> = len(tars)</td></tr>
<tr class="separator:a5f2f1b92a3e77bc8ab16df5dd055f8d0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a660921dd406cf93618f0e253d0d23df0"><td class="memItemLeft" align="right" valign="top"><a id="a660921dd406cf93618f0e253d0d23df0"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>p</b> = Pool(num_processes)</td></tr>
<tr class="separator:a660921dd406cf93618f0e253d0d23df0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afc801af6c0887f3764bdbb8fda8d0d67"><td class="memItemLeft" align="right" valign="top"><a id="afc801af6c0887f3764bdbb8fda8d0d67"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>timer_pool</b> = time()</td></tr>
<tr class="separator:afc801af6c0887f3764bdbb8fda8d0d67"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abc0bf88b80f5699dfbc9ec1000db7ac2"><td class="memItemLeft" align="right" valign="top"><a id="abc0bf88b80f5699dfbc9ec1000db7ac2"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>total</b></td></tr>
<tr class="separator:abc0bf88b80f5699dfbc9ec1000db7ac2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4387a5995670fb38e783a006a381783a"><td class="memItemLeft" align="right" valign="top"><a id="a4387a5995670fb38e783a006a381783a"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>ignore_errors</b></td></tr>
<tr class="separator:a4387a5995670fb38e783a006a381783a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9536ab4cd23a6ee56a4265150300cab4"><td class="memItemLeft" align="right" valign="top"><a id="a9536ab4cd23a6ee56a4265150300cab4"></a>
string&#160;</td><td class="memItemRight" valign="bottom"><b>cp_file</b> = classification_dir + '/' + str(datetime.datetime.now()) + ' ' + args.config</td></tr>
<tr class="separator:a9536ab4cd23a6ee56a4265150300cab4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><pre class="fragment">Classification script for UAF-Plankline

Usage:
    ./classification.py -c &lt;config.ini&gt; -d &lt;project directory&gt;

License:
    MIT License

    Copyright (c) 2023 Thomas Kelly

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
</pre> </div><h2 class="groupheader">Function Documentation</h2>
<a id="a058b4a55f59dd39b4354f2c7767a442f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a058b4a55f59dd39b4354f2c7767a442f">&#9670;&nbsp;</a></span>classify()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def classification.classify </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>tar_file</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Classify images contained within a TAR file.</pre> 
<p class="definition">Definition at line <a class="el" href="classification_8py_source.html#l00047">47</a> of file <a class="el" href="classification_8py_source.html">classification.py</a>.</p>
<div class="fragment"><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="keyword">def </span>classify(tar_file):</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Classify images contained within a TAR file.&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    timer_classify = time()</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    logger.info(<span class="stringliteral">&quot;Starting classify&quot;</span>)</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    date = datetime.datetime.now().strftime(<span class="stringliteral">&quot;%Y-%m-%d&quot;</span>)</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    basename = config[<span class="stringliteral">&#39;classification&#39;</span>][<span class="stringliteral">&#39;basename&#39;</span>]</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    logger.debug(f<span class="stringliteral">&quot;Basename for model run is {basename}.&quot;</span>)</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    logger.info(f<span class="stringliteral">&quot;Current ram usage (GB): {psutil.virtual_memory()[3]/1000000000:.2f}&quot;</span>)</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    logger.info(f<span class="stringliteral">&quot;Current cpu usage (%): {psutil.cpu_percent(4):.1f}&quot;</span>)</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="keywordflow">if</span> config[<span class="stringliteral">&#39;general&#39;</span>][<span class="stringliteral">&#39;compress_output&#39;</span>] == <span class="stringliteral">&#39;True&#39;</span>:</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        image_dir = tar_file.replace(<span class="stringliteral">&quot;.tar.gz&quot;</span>, <span class="stringliteral">&quot;&quot;</span>) <span class="comment"># remove extension</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        tar_identifier = os.path.basename(image_dir)</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        tmp_dir = fast_scratch + <span class="stringliteral">&#39;/&#39;</span> + tar_identifier</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        os.makedirs(tmp_dir, permis, exist_ok = <span class="keyword">True</span>)</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        log_file = f<span class="stringliteral">&quot;{classification_dir}/{tar_identifier}-{date}.log&quot;</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        image_dir = tar_file.replace(<span class="stringliteral">&quot;.tar&quot;</span>, <span class="stringliteral">&quot;&quot;</span>) <span class="comment"># remove extension</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        tar_identifier = os.path.basename(image_dir)</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        tmp_dir = fast_scratch + <span class="stringliteral">&#39;/&#39;</span> + tar_identifier</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        os.makedirs(tmp_dir, permis, exist_ok = <span class="keyword">True</span>)</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        log_file = f<span class="stringliteral">&quot;{classification_dir}/{tar_identifier}-{date}.log&quot;</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160; </div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    image_dir = tmp_dir</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160; </div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    gpu_id = queue.get()</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    logger.info(f<span class="stringliteral">&quot;Starting on GPU {gpu_id}&quot;</span>)</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    logger.info(f<span class="stringliteral">&#39;image_dir: {image_dir}&#39;</span>)</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    logger.info(f<span class="stringliteral">&#39;tar_identifier: {tar_identifier}&#39;</span>)</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160; </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="comment"># Untar files</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="keywordflow">if</span> config[<span class="stringliteral">&#39;general&#39;</span>][<span class="stringliteral">&#39;compress_output&#39;</span>] == <span class="stringliteral">&#39;True&#39;</span>:</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        untar_cmd = f<span class="stringliteral">&#39;tar -xzf &quot;{tar_file}&quot; -C &quot;{image_dir}&quot; --strip-components=4 --wildcards &quot;*.png&quot;  &gt;&gt; &quot;{log_file}&quot; 2&gt;&amp;1&#39;</span> <span class="comment"># TBK change strip-components to what you need.</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        logger.debug(<span class="stringliteral">&#39;Untarring+unzipping files: &#39;</span> + untar_cmd)</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        untar_cmd = f<span class="stringliteral">&#39;tar -xf &quot;{tar_file}&quot; -C &quot;{image_dir}&quot; --strip-components=4 --wildcards &quot;*.png&quot;  &gt;&gt; &quot;{log_file}&quot; 2&gt;&amp;1&#39;</span> <span class="comment"># TBK change strip-components to what you need.</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        logger.debug(<span class="stringliteral">&#39;Untarring files: &#39;</span> + untar_cmd)</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    timer_untar = time()</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    os.system(untar_cmd)</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    timer_untar = time() - timer_untar</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    logger.debug(f<span class="stringliteral">&quot;Untarring files took {timer_untar:.3f} s.&quot;</span>)</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160; </div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment"># Perform classification.</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    scnn_cmd  = f<span class="stringliteral">&quot;cd &#39;{scnn_directory}&#39;; nohup &#39;{scnn_command}&#39; -start {epoch} -stop {epoch} -unl &#39;{image_dir}&#39; -cD {gpu_id} -basename {basename} &gt;&gt; &#39;{log_file}&#39; 2&gt;&amp;1&quot;</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    logger.debug(<span class="stringliteral">&#39;Running SCNN: &#39;</span> + scnn_cmd)</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    logger.info(<span class="stringliteral">&#39;Start SCNN.&#39;</span>)</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160; </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    timer_scnn = time()</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    os.system(scnn_cmd)</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    timer_scnn = time() - timer_scnn</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    logger.info(<span class="stringliteral">&#39;End SCNN.&#39;</span>)</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    logger.debug(f<span class="stringliteral">&quot;SCNN took {timer_scnn:.3f} s.&quot;</span>)</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160; </div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="comment"># Move the csv file resulting from classification.</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    logger.info(f<span class="stringliteral">&quot;Looking for files in {scnn_directory}/Data/{basename}/ that match the id: {tar_identifier}&quot;</span>)</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    csv_path = glob.glob(f<span class="stringliteral">&quot;{scnn_directory}/Data/{basename}/*{tar_identifier[10:]}*&quot;</span>)</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="keywordflow">if</span> len(csv_path) &gt; 0:</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        csv_path = csv_path[0]</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        csv_file = f<span class="stringliteral">&quot;{classification_dir}/{tar_identifier}.csv&quot;</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160; </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        timer_move = time()</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        shutil.move(csv_path, csv_file)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        os.chmod(csv_file, permis)</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        timer_move = time() - timer_move</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        logger.debug(f<span class="stringliteral">&quot;Moving csv(s) took {timer_move:.3f} s.&quot;</span>)</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        </div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        logger.error(f<span class="stringliteral">&#39;No classification file found for {tar_identifier}&#39;</span>)</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160; </div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="comment"># Clean directories to make space.</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    shutil.rmtree(image_dir)</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160; </div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    queue.put(gpu_id) <span class="comment"># add the gpu id to the queue so that it can be allocated again</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    logger.debug(<span class="stringliteral">&#39;End classify.&#39;</span>)</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    timer_classify = time() - timer_classify</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    logger.debug(f<span class="stringliteral">&quot;Total classification process took {timer_classify:.3f} s.&quot;</span>)</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160; </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="keywordflow">if</span> config[<span class="stringliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;preprocess&#39;</span>]:</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        timer_pre = time()</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        logger.debug(<span class="stringliteral">&#39;Preprocessing requested.&#39;</span>)</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160; </div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        pre_cmd = <span class="stringliteral">&#39;Rscript &quot;&#39;</span> + config[<span class="stringliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;script&#39;</span>] + <span class="stringliteral">&#39;&quot; &#39;</span> + config[<span class="stringliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;dt&#39;</span>] + <span class="stringliteral">&#39; &#39;</span> + config[<span class="stringliteral">&#39;R&#39;</span>][<span class="stringliteral">&#39;p_threshold&#39;</span>] + <span class="stringliteral">&#39; &quot;&#39;</span> + csv_file + <span class="stringliteral">&#39;&quot;&#39;</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        logger.debug(f<span class="stringliteral">&quot;Running preprocessing cmd: {pre_cmd}&quot;</span>)</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        os.system(pre_cmd)</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160; </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        timer_pre = time() - timer_pre</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        logger.debug(f<span class="stringliteral">&quot;Preprocessing took {timer_pre:.3f} s.&quot;</span>)</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160; </div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160; </div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
