<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UAF-Plankline: pull_all.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">UAF-Plankline
   &#160;<span id="projectnumber">v1.0</span>
   </div>
   <div id="projectbrief">THe UAF implementation of OSU&#39;s Plankline image processing system</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('pull__all_8py_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">pull_all.py</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="namespacepull__all.html">    1</a></span>&#160;<span class="comment">#!/usr/bin/env python3</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="stringliteral">&quot;&quot;&quot;Image Pulling script for UAF-Plankline</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="stringliteral"></span> </div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="stringliteral">Usage:</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="stringliteral">    ./pull_all.py -d &lt;project directory&gt;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="stringliteral"></span> </div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="stringliteral">License:</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="stringliteral">    MIT License</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="stringliteral"></span> </div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="stringliteral">    Copyright (c) 2023 Thomas Kelly</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="stringliteral"></span> </div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="stringliteral">    Permission is hereby granted, free of charge, to any person obtaining a copy</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="stringliteral">    of this software and associated documentation files (the &quot;Software&quot;), to deal</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="stringliteral">    in the Software without restriction, including without limitation the rights</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="stringliteral">    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="stringliteral">    copies of the Software, and to permit persons to whom the Software is</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="stringliteral">    furnished to do so, subject to the following conditions:</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="stringliteral"></span> </div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="stringliteral">    The above copyright notice and this permission notice shall be included in all</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="stringliteral">    copies or substantial portions of the Software.</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="stringliteral"></span> </div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="stringliteral">    THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="stringliteral">    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="stringliteral">    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="stringliteral">    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="stringliteral">    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="stringliteral">    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="stringliteral">    SOFTWARE.</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160; </div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">import</span> os</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">import</span> glob</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">import</span> argparse</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">import</span> csv <span class="comment"># to parse all of the csv files</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">import</span> tarfile <span class="comment"># untar the images</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">import</span> re</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">import</span> shutil <span class="comment"># for copying files</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160; </div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"># arg types</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">def </span>directory(arg):</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="keywordflow">if</span> os.path.isdir(arg):</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;        <span class="keywordflow">return</span> arg</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        <span class="keywordflow">raise</span> argparse.ArgumentTypeError(<span class="stringliteral">&quot;Not a valid directory path&quot;</span>)</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160; </div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keyword">def </span>csv_type(arg):</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.isfile(arg):</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        <span class="keywordflow">raise</span> argparse.ArgumentTypeError(<span class="stringliteral">&quot;Not a file&quot;</span>)</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> arg.endswith(<span class="stringliteral">&quot;.csv&quot;</span>):</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        <span class="keywordflow">raise</span> argparse.ArgumentTypeError(<span class="stringliteral">&quot;Not a csv file&quot;</span>)</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;         <span class="keywordflow">return</span> arg</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keyword">def </span>float01(arg):</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> float(arg):</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        <span class="keywordflow">raise</span> argparse.ArgumentTypeError(<span class="stringliteral">&quot;Not a floating point number&quot;</span>)</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    arg = float(arg)</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> (arg &lt; 1.0 <span class="keywordflow">and</span> arg &gt; 0.0):</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        <span class="keywordflow">raise</span> argparse.ArgumentTypeError(<span class="stringliteral">&quot;Not a floating point value between 0 and 1&quot;</span>)</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        <span class="keywordflow">return</span> arg</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment"># check to make sure the image doesn&#39;t already exist. Some images in different tars are given the same name</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="keyword">def </span>add_unique_postfix(fn):</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(fn): <span class="comment"># if the file name doesn&#39;t exist, don&#39;t change the name</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        <span class="keywordflow">return</span> fn</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; </div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    path, name = os.path.split(fn)</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    name, ext = os.path.splitext(name)</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160; </div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    make_fn = <span class="keyword">lambda</span> i: os.path.join(path, <span class="stringliteral">&#39;%s(%d)%s&#39;</span> % (name, i, ext))</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160; </div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(2, 10000): <span class="comment"># finds a number that is not used to put as the suffix</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        uni_fn = make_fn(i)</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(uni_fn):</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;            <span class="keywordflow">return</span> uni_fn</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="keyword">def </span>get_parser(): <span class="comment"># get command line options</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    parser = argparse.ArgumentParser(description=<span class="stringliteral">&quot;Tool that was created to help expand the data for the taxon that we do not have many images of by utilizing the data from the images that were already classified.&quot;</span>)</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="comment"># you should do many taxon at once since a lot of the time is lost unzipping files so it is only slightly less efficient</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;-t&quot;</span>, <span class="stringliteral">&quot;--taxon&quot;</span>, required=<span class="keyword">False</span>, type=str, nargs=<span class="stringliteral">&#39;+&#39;</span>, help=<span class="stringliteral">&quot;The taxons that you are looking to find from the csv files. This should be given as a list of taxon separated by a space.&quot;</span>)</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160; </div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    selectgroup = parser.add_mutually_exclusive_group(required=<span class="keyword">True</span>)</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    selectgroup.add_argument(<span class="stringliteral">&quot;-p&quot;</span>, <span class="stringliteral">&quot;--probability_taxon&quot;</span>, type=float01, help=<span class="stringliteral">&quot;The probability that a taxon needs to be over for the program to extract image extract the image, this should be a value between (0,1)&quot;</span>)</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    selectgroup.add_argument(<span class="stringliteral">&quot;-b&quot;</span>, <span class="stringliteral">&quot;--best_taxon&quot;</span>, action=<span class="stringliteral">&quot;store_true&quot;</span>, help=<span class="stringliteral">&quot;Extracts the images if the image was classified as a certain taxa, that is one of the taxons that you are trying to find.&quot;</span>)</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160; </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    inputgroup = parser.add_mutually_exclusive_group(required=<span class="keyword">True</span>)</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    inputgroup.add_argument(<span class="stringliteral">&quot;-d&quot;</span>, <span class="stringliteral">&quot;--input_drive&quot;</span>, type=directory, help=<span class="stringliteral">&quot;The directory that you want to be pulling csv files from to look for images&quot;</span>)</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    inputgroup.add_argument(<span class="stringliteral">&quot;-c&quot;</span>, <span class="stringliteral">&quot;--input_csv&quot;</span>, type=csv_type, help=<span class="stringliteral">&quot;The csv file that you want to look for taxon images.&quot;</span>)</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160; </div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;-o&quot;</span>, <span class="stringliteral">&quot;--output&quot;</span>, required=<span class="keyword">True</span>, type=directory, help=<span class="stringliteral">&quot;The directory that you want to put the taxon folders of images&quot;</span>)</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;-r&quot;</span>, <span class="stringliteral">&quot;--raw_tars&quot;</span>, required=<span class="keyword">True</span>, type=directory, help=<span class="stringliteral">&quot;The directory of all of the tar images that correspond to the csv data&quot;</span>)</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;-m&quot;</span>, <span class="stringliteral">&quot;--min_images&quot;</span>, type=int, default=0, help=<span class="stringliteral">&quot;The minimum number of images you need to have in a tar.gz in order to unzip it, this defaults to 0&quot;</span>)</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;-dc&quot;</span>, <span class="stringliteral">&quot;--different_columns&quot;</span>, action=<span class="stringliteral">&quot;store_true&quot;</span>, default=<span class="keyword">False</span>, help=<span class="stringliteral">&quot;Checks all of the csvs and tar.gz files. This should be used if the csv files do not follow the same pattern.&quot;</span>)</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    parser.add_argument(<span class="stringliteral">&quot;-s&quot;</span>, <span class="stringliteral">&quot;--strict_subclasses&quot;</span>, action=<span class="stringliteral">&quot;store_true&quot;</span>, default=<span class="keyword">False</span>, help=<span class="stringliteral">&quot;Doesn&#39;t find any substrings, only uses the taxon names that you input exactly&quot;</span>)</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160; </div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="keywordflow">return</span> parser</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160; </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="keyword">def </span>validate_args(parser): <span class="comment"># verify the command line options that the user plugged in and print them out</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    args = parser.parse_args()</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    tars_dir = args.raw_tars</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160; </div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    csvs = []</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    file_dict = {}</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    if(args.input_drive): <span class="comment"># several csv files</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        csvs = glob.glob(args.input_drive + <span class="stringliteral">&quot;/*.csv&quot;</span>)<span class="comment"># do something here so that program goes through and gets all of the csv files</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        if(len(csvs) == 0):</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            parser.error(<span class="stringliteral">&quot;-d, --input_drive Directory does not contain any csv files&quot;</span>)</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        print(<span class="stringliteral">&quot;Input Drive: %s&quot;</span> % (args.input_drive))</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        print(<span class="stringliteral">&quot;Number of Input CSVs: %d&quot;</span> % (len(csvs)))</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160; </div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="comment"># create dictionary linking between tar files and csvs</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        file_dict = {}</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="keywordflow">for</span> tar <span class="keywordflow">in</span> os.listdir(tars_dir):</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            unique_name = os.path.basename(tar).replace(<span class="stringliteral">&quot;.tar&quot;</span>,<span class="stringliteral">&quot;&quot;</span>)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            matches = glob.glob(str(args.input_drive) + <span class="stringliteral">&quot;/*&quot;</span> + str(unique_name) + <span class="stringliteral">&quot;*.csv&quot;</span>)</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <span class="keywordflow">if</span> (len(matches) &gt;= 1):</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                csv_filename = matches[0]</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                <span class="keywordflow">if</span> (csv_filename <span class="keywordflow">not</span> <span class="keywordflow">in</span> file_dict):</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                    file_dict[csv_filename] = os.path.join(tars_dir, tar)</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                    print(<span class="stringliteral">&quot;Error: More than one tar file have been matched with a csv file.&quot;</span>)</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                    exit()</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160; </div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">else</span>: <span class="comment"># a single csv files</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        print(<span class="stringliteral">&quot;Input CSV:&quot;</span>, args.input_csv)</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <span class="keywordflow">for</span> tar <span class="keywordflow">in</span> os.listdir(tars_dir):</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;            unique_name = os.path.basename(tar).replace(<span class="stringliteral">&quot;.tar&quot;</span>,<span class="stringliteral">&quot;&quot;</span>)</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            <span class="keywordflow">if</span> (unique_name <span class="keywordflow">in</span> os.path.basename(args.input_csv)):</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160; </div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                <span class="keywordflow">if</span> (args.input_csv <span class="keywordflow">not</span> <span class="keywordflow">in</span> file_dict):</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                    file_dict[args.input_csv] = os.path.join(tars_dir, tar)</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                    print(<span class="stringliteral">&quot;Error: More than one tar file have been matched with the given csv file.&quot;</span>)</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                    exit()</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160; </div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        csvs.append(args.input_csv)</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160; </div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="keywordflow">for</span> csv_file <span class="keywordflow">in</span> csvs:</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="keywordflow">if</span> (csv_file <span class="keywordflow">not</span> <span class="keywordflow">in</span> file_dict):</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;            print(file_dict)</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;            parser.error(<span class="stringliteral">&quot;r, --raw_tars does not have a corresponding tar for the csv file %s&quot;</span> % csv_file)</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160; </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    print(<span class="stringliteral">&quot;Raw tar Directory:&quot;</span>, tars_dir)</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160; </div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    if(args.output):</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        out_dir = args.output</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        if(len(glob.glob(out_dir + <span class="stringliteral">&quot;/*&quot;</span>)) &gt; 0):</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;            parser.error(<span class="stringliteral">&quot;-o, --output Directory can not contain any any files or directories so that we can avoid overwriting existing files.&quot;</span>)</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        print(<span class="stringliteral">&quot;Output Directory:&quot;</span>, out_dir)</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160; </div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    min_images = args.min_images</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    if(min_images &lt; 0):</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        parser.error(<span class="stringliteral">&quot;-m, --min_images The minimum numbers of images you extract needs to be a positive integer.&quot;</span>)</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    print(<span class="stringliteral">&quot;Minimum images needed to unzip:&quot;</span>, min_images)</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160; </div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    if(args.best_taxon):</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        print(<span class="stringliteral">&quot;\n----- Finding chosen taxon where they are the top probability -----&quot;</span>)</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        probability = args.probability_taxon</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        print(<span class="stringliteral">&quot;\n----- Finding chosen taxon with probabilities above %s -----&quot;</span> % probability)</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160; </div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="keywordflow">return</span> csvs, tars_dir, out_dir, file_dict, min_images, args.best_taxon, args.probability_taxon, args.different_columns, args.strict_subclasses</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160; </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="keyword">def </span>find_all_taxon(csv): <span class="comment"># NOTE: this is assuming the csv&#39;s collumns are all the same.</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    taxon_exist = next(csv)[1:]</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="keywordflow">return</span> taxon_exist</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160; </div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160; </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="keyword">def </span>invalid_taxon(parser, taxon_exist, all_taxon): <span class="comment"># see if any of the taxon were not substrings of the column names in the csv files.</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    args = parser.parse_args()</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    numInvalid = 0 <span class="comment"># store the number of invalid taxon</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="keywordflow">for</span> i, taxon <span class="keywordflow">in</span> enumerate(all_taxon):</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        if(taxon <span class="keywordflow">not</span> <span class="keywordflow">in</span> taxon_exist):</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            if(args.different_columns):</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                numInvalid += 1</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                print(<span class="stringliteral">&quot;\&quot;%s\&quot; was ignored since it isn&#39;t a valid substring of a taxon name for this csv file&quot;</span> % (taxon))</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                parser.error(<span class="stringliteral">&quot;-t, --taxon Taxon \&quot;%s\&quot; is not a valid substring of a taxon name&quot;</span> % (taxon))</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <span class="keywordflow">if</span> numInvalid == len(all_taxon): <span class="comment"># determine if there are any valid taxon that were inputted</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">True</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">False</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment"># print out all of the taxon this program is searching for</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="keyword">def </span>print_taxon(taxon_locations):</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    print(<span class="stringliteral">&quot;Finding the sub_taxon:&quot;</span>)</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keywordflow">for</span> i, (taxon, sub_taxon) <span class="keywordflow">in</span> enumerate(taxon_locations.values()):</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        print(<span class="stringliteral">&quot;%d. %s&quot;</span> % (i, sub_taxon))</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160; </div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keyword">def </span>find_top(csv, taxon_locations):</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    matched_images = dict()</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordflow">for</span> row <span class="keywordflow">in</span> csv:</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        top_col = 1</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keywordflow">for</span> col, prob <span class="keywordflow">in</span> enumerate(row):</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            <span class="keywordflow">if</span> col &lt; 2: <span class="keywordflow">continue</span> <span class="comment"># skip the image name row</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;            <span class="comment"># TODO maybe add quickselect here to get the top k elements</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            <span class="keywordflow">if</span> float(prob) &gt; float(row[top_col]):</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                 top_col = col</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <span class="keywordflow">if</span> top_col <span class="keywordflow">in</span> taxon_locations: <span class="comment"># check if top_col is in the dictionary</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;            image = os.path.basename(row[0])</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;            matched_images[image] = [taxon_locations[top_col]] <span class="comment"># add the image to the matched images dict</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordflow">return</span> matched_images</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160; </div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="keyword">def </span>find_above_prob(csv, taxon_locations, probability):</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    matched_images = dict()</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordflow">for</span> row <span class="keywordflow">in</span> csv:</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(taxon_locations)):</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;            <span class="keywordflow">if</span> float(row[i+1]) &gt; probability: <span class="comment"># if one is found this tar.gz now needs to be unzipped</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                image = os.path.basename(row[0])</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                <span class="keywordflow">if</span> image <span class="keywordflow">not</span> <span class="keywordflow">in</span> matched_images:</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                     matched_images[image] = [taxon_locations[i]]</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                     matched_images[image].append(taxon_locations[i]) <span class="comment"># add taxon to hashmap for the image</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordflow">return</span> matched_images</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160; </div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="keyword">def </span>untar(tar, out_dir):</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    print(<span class="stringliteral">&quot;Unzipping %s into %s&quot;</span> % (tar, out_dir))</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    t = tarfile.open(tar, <span class="stringliteral">&#39;r&#39;</span>) <span class="comment"># set up the file pointer for the tar file</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    t.extractall(out_dir) <span class="comment"># all images into the out_dir</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160; </div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="keyword">def </span>build_structure(path_array, taxon_locations):</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> enumerate(path_array): <span class="comment"># shouldn&#39;t ever be that many, dependant on your minimum detection probability.</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        dir_structure = <span class="stringliteral">&quot;/&quot;</span> + taxon_locations + <span class="stringliteral">&quot;/&quot;</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        os.makedirs(out_dir + dir_structure, exist_ok = <span class="keyword">True</span>) <span class="comment"># TODO: maybe move this to another place so that it is not done in a loop</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        if(len(path_array) &gt; 1): <span class="comment"># then we will need to copy the image to multiple directories</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;            if(i &lt; len(path_array) - 1):</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                shutil.copy2(img, out_dir + dir_structure)</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            <span class="keywordflow">else</span>: <span class="comment"># move the last one instead of copying it</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                shutil.move(img, out_dir + dir_structure)</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="keywordflow">else</span>:  <span class="comment"># move to one directory</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;            image_unique = add_unique_postfix(out_dir + dir_structure + os.path.basename(img)) <span class="comment"># make sure there is a unique image name</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;            shutil.move(img, image_unique)</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160; </div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="keywordflow">if</span> __name__ == <span class="stringliteral">&quot;__main__&quot;</span>:</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Main entry to pull_all.py&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    </div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    v_string = <span class="stringliteral">&quot;V2023.09.05&quot;</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    parser = get_parser() <span class="comment"># get command line arguments</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    csvs, tars_dir, out_dir, file_dict, min_images, best, probability, different, strict = validate_args(parser) <span class="comment"># error check arguments further</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    print(v_string)</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    print(file_dict)</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    f = open(csvs[0])</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    _csv = csv.reader(f)</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    e_taxon = find_all_taxon(_csv) <span class="comment"># read the taxon from the first csv file</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    f.close()</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160; </div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="comment"># this is the main processing part of the program</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">for</span> csv_file <span class="keywordflow">in</span> csvs: <span class="comment"># loop through all of the csv files</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        print(<span class="stringliteral">&quot;\nFinding images from&quot;</span>, csv_file)</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160; </div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        f = open(csv_file)</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        _csv = csv.reader(f)</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        name_line = next(_csv) <span class="comment"># remove nameline</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        tar_file = file_dict[csv_file]</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        untar(tar_file, out_dir)</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160; </div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <span class="keywordflow">for</span> taxon_locations <span class="keywordflow">in</span> e_taxon:</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            matched_images = dict()</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;            matched_images = find_above_prob(_csv, taxon_locations, probability)</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160; </div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;            print(f<span class="stringliteral">&quot;Found {len(matched_images)} images in {csv_file} for {taxon_locations}&quot;</span>)</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;            print(<span class="stringliteral">&quot;Building file structure&quot;</span>)</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            <span class="keywordflow">for</span> img <span class="keywordflow">in</span> glob.glob(out_dir + f<span class="stringliteral">&#39;/{taxon_locations}*.jpg&#39;</span>): <span class="comment"># loop through all the images in the untared directory</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                path_array = matched_images[os.path.basename(img)]</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                build_structure(path_array, taxon_locations) <span class="comment"># move all of the images to the correct sub-directory</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        f.close()</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160; </div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    print(<span class="stringliteral">&quot;----- Done -----&quot;</span>)</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>pull_all.py</b></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
