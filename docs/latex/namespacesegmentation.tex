\hypertarget{namespacesegmentation}{}\doxysection{segmentation Namespace Reference}
\label{namespacesegmentation}\index{segmentation@{segmentation}}
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
def \mbox{\hyperlink{namespacesegmentation_ad33a0fb68e616156cf9cf6fdd13f4a98}{seg\+\_\+ff}} (avi, seg\+\_\+output, SNR, segment\+\_\+path)
\item 
def \mbox{\hyperlink{namespacesegmentation_ae1095b4eb15bba2a5289cd64244895e0}{local\+\_\+main}} (avi)
\item 
def \mbox{\hyperlink{namespacesegmentation_a9da45244b61d9c55b211ca042591787f}{Fix\+Avi\+Names}} (avis)
\end{DoxyCompactItemize}
\doxysubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{namespacesegmentation_ae03cc482eca646a5fd77e7f6a793c389}\label{namespacesegmentation_ae03cc482eca646a5fd77e7f6a793c389}} 
string {\bfseries v\+\_\+string} = \char`\"{}V2023.\+09.\+05\char`\"{}
\item 
\mbox{\Hypertarget{namespacesegmentation_a007a849d2f0ae97c4f305387e7f98db9}\label{namespacesegmentation_a007a849d2f0ae97c4f305387e7f98db9}} 
{\bfseries parser} = argparse.\+Argument\+Parser(description=\char`\"{}Segmentation tool for the plankton pipeline. Uses ffmpeg and \mbox{\hyperlink{namespacesegmentation_ad33a0fb68e616156cf9cf6fdd13f4a98}{seg\+\_\+ff}} to segment a video into crops of plankton\char`\"{})
\item 
\mbox{\Hypertarget{namespacesegmentation_a88033d4ec4abe45ce49387d3c3744f75}\label{namespacesegmentation_a88033d4ec4abe45ce49387d3c3744f75}} 
{\bfseries required}
\item 
\mbox{\Hypertarget{namespacesegmentation_a9f0e2ec68370d78e3005c3bb58cfb44e}\label{namespacesegmentation_a9f0e2ec68370d78e3005c3bb58cfb44e}} 
{\bfseries True}
\item 
\mbox{\Hypertarget{namespacesegmentation_a70e0fa47d25f99c9ffbd60c86bed5583}\label{namespacesegmentation_a70e0fa47d25f99c9ffbd60c86bed5583}} 
{\bfseries help}
\item 
\mbox{\Hypertarget{namespacesegmentation_acf855c65ed37ac29530c53fed9349db4}\label{namespacesegmentation_acf855c65ed37ac29530c53fed9349db4}} 
{\bfseries args} = parser.\+parse\+\_\+args()
\item 
\mbox{\Hypertarget{namespacesegmentation_afbed912396b4121f26215f3235c623af}\label{namespacesegmentation_afbed912396b4121f26215f3235c623af}} 
{\bfseries config} = configparser.\+Config\+Parser()
\item 
\mbox{\Hypertarget{namespacesegmentation_a1f250d35c7187397e606c2f66c992262}\label{namespacesegmentation_a1f250d35c7187397e606c2f66c992262}} 
{\bfseries working\+\_\+dir} = os.\+path.\+abspath(args.\+directory)
\item 
\mbox{\Hypertarget{namespacesegmentation_a880fdf7a1ad96c3cea6121258c693d79}\label{namespacesegmentation_a880fdf7a1ad96c3cea6121258c693d79}} 
\mbox{\hyperlink{namespacesegmentation_a880fdf7a1ad96c3cea6121258c693d79}{defaults}}
\begin{DoxyCompactList}\small\item\em Setup logger. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{namespacesegmentation_a6cebbda01bf60f456cc128b87023d0bd}\label{namespacesegmentation_a6cebbda01bf60f456cc128b87023d0bd}} 
{\bfseries logger} = logging.\+get\+Logger(\textquotesingle{}s\+Logger\textquotesingle{})
\item 
\mbox{\Hypertarget{namespacesegmentation_aef72a95b7cb4b3b8a765b2a82929bfd2}\label{namespacesegmentation_aef72a95b7cb4b3b8a765b2a82929bfd2}} 
string {\bfseries cp\+\_\+file} = working\+\_\+dir + \textquotesingle{}/\textquotesingle{} + str(datetime.\+datetime.\+now()) + \textquotesingle{} \textquotesingle{} + args.\+config
\item 
\mbox{\Hypertarget{namespacesegmentation_a74a225402da56fbeba1bd4aceb71e572}\label{namespacesegmentation_a74a225402da56fbeba1bd4aceb71e572}} 
\mbox{\hyperlink{namespacesegmentation_a74a225402da56fbeba1bd4aceb71e572}{permis}} = int(config\mbox{[}\textquotesingle{}general\textquotesingle{}\mbox{]}\mbox{[}\textquotesingle{}dir\+\_\+permissions\textquotesingle{}\mbox{]})
\begin{DoxyCompactList}\small\item\em Read in config options\+: \end{DoxyCompactList}\item 
\mbox{\Hypertarget{namespacesegmentation_a85d98d35817ba188546e5a31e4a9c865}\label{namespacesegmentation_a85d98d35817ba188546e5a31e4a9c865}} 
{\bfseries SNR} = int(config\mbox{[}\textquotesingle{}segmentation\textquotesingle{}\mbox{]}\mbox{[}\textquotesingle{}signal\+\_\+to\+\_\+noise\textquotesingle{}\mbox{]})
\item 
\mbox{\Hypertarget{namespacesegmentation_a0fe2df1918eaac3f95e33251bbc65353}\label{namespacesegmentation_a0fe2df1918eaac3f95e33251bbc65353}} 
{\bfseries num\+\_\+processes} = int(config\mbox{[}\textquotesingle{}segmentation\textquotesingle{}\mbox{]}\mbox{[}\textquotesingle{}segment\+\_\+processes\textquotesingle{}\mbox{]})
\item 
\mbox{\Hypertarget{namespacesegmentation_a917e0e2fb67954e9d6f8d609245744f8}\label{namespacesegmentation_a917e0e2fb67954e9d6f8d609245744f8}} 
{\bfseries segment\+\_\+path} = config\mbox{[}\textquotesingle{}segmentation\textquotesingle{}\mbox{]}\mbox{[}\textquotesingle{}segment\textquotesingle{}\mbox{]}
\item 
\mbox{\Hypertarget{namespacesegmentation_a9dfda89286acc02733bdde07bbd97c33}\label{namespacesegmentation_a9dfda89286acc02733bdde07bbd97c33}} 
{\bfseries fast\+\_\+scratch} = config\mbox{[}\textquotesingle{}segmentation\textquotesingle{}\mbox{]}\mbox{[}\textquotesingle{}fast\+\_\+scratch\textquotesingle{}\mbox{]}
\item 
\mbox{\Hypertarget{namespacesegmentation_adaf9ba4195e5a61b79cc8bcb80ef070f}\label{namespacesegmentation_adaf9ba4195e5a61b79cc8bcb80ef070f}} 
string {\bfseries raw\+\_\+dir} = working\+\_\+dir + \char`\"{}/raw\char`\"{}
\item 
\mbox{\Hypertarget{namespacesegmentation_af8859c779a0df8865adfc6ed6b1bdfb1}\label{namespacesegmentation_af8859c779a0df8865adfc6ed6b1bdfb1}} 
string {\bfseries segment\+\_\+dir} = working\+\_\+dir + \char`\"{}/segmentation\char`\"{}
\item 
\mbox{\Hypertarget{namespacesegmentation_aada8dd7ea5d5b7661c94a364037c5845}\label{namespacesegmentation_aada8dd7ea5d5b7661c94a364037c5845}} 
{\bfseries exist\+\_\+ok}
\item 
\mbox{\Hypertarget{namespacesegmentation_ae0815da3acd45794dc67aaf790211456}\label{namespacesegmentation_ae0815da3acd45794dc67aaf790211456}} 
list {\bfseries avis} = \mbox{[}$\,$\mbox{]}
\item 
\mbox{\Hypertarget{namespacesegmentation_a2bdf2d9493cf2338ad05113cdc3b04f5}\label{namespacesegmentation_a2bdf2d9493cf2338ad05113cdc3b04f5}} 
{\bfseries p} = Pool(num\+\_\+processes)
\item 
\mbox{\Hypertarget{namespacesegmentation_a0597640deeb8df65e77d0deea06b229b}\label{namespacesegmentation_a0597640deeb8df65e77d0deea06b229b}} 
{\bfseries timer\+\_\+pool} = time()
\item 
\mbox{\Hypertarget{namespacesegmentation_abde237634ed961aa705349c342b49cc3}\label{namespacesegmentation_abde237634ed961aa705349c342b49cc3}} 
{\bfseries total}
\item 
\mbox{\Hypertarget{namespacesegmentation_a9830b622d6cb7d0ae27b395a37fbc3aa}\label{namespacesegmentation_a9830b622d6cb7d0ae27b395a37fbc3aa}} 
{\bfseries ignore\+\_\+errors}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
\begin{DoxyVerb}Segmentation script for UAF-Plankline

Usage:
    ./segmentation.py -c <config.ini> -d <project directory>

License:
    MIT License

    Copyright (c) 2023 Thomas Kelly

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
\end{DoxyVerb}
 

\doxysubsection{Function Documentation}
\mbox{\Hypertarget{namespacesegmentation_a9da45244b61d9c55b211ca042591787f}\label{namespacesegmentation_a9da45244b61d9c55b211ca042591787f}} 
\index{segmentation@{segmentation}!FixAviNames@{FixAviNames}}
\index{FixAviNames@{FixAviNames}!segmentation@{segmentation}}
\doxysubsubsection{\texorpdfstring{FixAviNames()}{FixAviNames()}}
{\footnotesize\ttfamily def segmentation.\+Fix\+Avi\+Names (\begin{DoxyParamCaption}\item[{}]{avis }\end{DoxyParamCaption})}

\begin{DoxyVerb} Helper function to remove spaces in names. 
TODO: I think this is unnecessary any more.
\end{DoxyVerb}
 

Definition at line 134 of file segmentation.\+py.


\begin{DoxyCode}{0}
\DoxyCodeLine{134 \textcolor{keyword}{def }FixAviNames(avis):}
\DoxyCodeLine{135     \textcolor{stringliteral}{"{}"{}"{} Helper function to remove spaces in names. }}
\DoxyCodeLine{136 \textcolor{stringliteral}{    TODO: I think this is unnecessary any more.}}
\DoxyCodeLine{137 \textcolor{stringliteral}{    "{}"{}"{}}}
\DoxyCodeLine{138     n = 0}
\DoxyCodeLine{139     \textcolor{keywordflow}{for} Name \textcolor{keywordflow}{in} avis:}
\DoxyCodeLine{140         FixedName = Name.replace(\textcolor{stringliteral}{' '}, \textcolor{stringliteral}{'-\/'})}
\DoxyCodeLine{141         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} (FixedName == Name):}
\DoxyCodeLine{142             os.rename(Name, FixedName)}
\DoxyCodeLine{143         avis[n] = FixedName}
\DoxyCodeLine{144         n += 1}
\DoxyCodeLine{145     \textcolor{keywordflow}{return} avis}
\DoxyCodeLine{146 }
\DoxyCodeLine{147 }

\end{DoxyCode}
\mbox{\Hypertarget{namespacesegmentation_ae1095b4eb15bba2a5289cd64244895e0}\label{namespacesegmentation_ae1095b4eb15bba2a5289cd64244895e0}} 
\index{segmentation@{segmentation}!local\_main@{local\_main}}
\index{local\_main@{local\_main}!segmentation@{segmentation}}
\doxysubsubsection{\texorpdfstring{local\_main()}{local\_main()}}
{\footnotesize\ttfamily def segmentation.\+local\+\_\+main (\begin{DoxyParamCaption}\item[{}]{avi }\end{DoxyParamCaption})}

\begin{DoxyVerb}A single threaded function that takes one avi path.\end{DoxyVerb}
 

Definition at line 69 of file segmentation.\+py.


\begin{DoxyCode}{0}
\DoxyCodeLine{69 \textcolor{keyword}{def }local\_main(avi):}
\DoxyCodeLine{70     \textcolor{stringliteral}{"{}"{}"{}A single threaded function that takes one avi path."{}"{}"{}}}
\DoxyCodeLine{71     logger.info(\textcolor{stringliteral}{"{}Starting local\_main."{}})}
\DoxyCodeLine{72 }
\DoxyCodeLine{73     \textcolor{comment}{\# setup all of the local paths for the avi}}
\DoxyCodeLine{74     avi\_file = os.path.basename(avi) \textcolor{comment}{\# get only the file part of the full path}}
\DoxyCodeLine{75     avi\_date\_code = os.path.splitext(avi\_file)[0] \textcolor{comment}{\# remove .avi}}
\DoxyCodeLine{76     avi\_segment\_scratch = fast\_scratch + \textcolor{stringliteral}{"{}/"{}} + avi\_date\_code}
\DoxyCodeLine{77     seg\_output = avi\_segment\_scratch + \textcolor{stringliteral}{"{}\_s"{}}}
\DoxyCodeLine{78     out\_dir = segment\_dir + \textcolor{stringliteral}{"{}/"{}} + avi\_date\_code}
\DoxyCodeLine{79 }
\DoxyCodeLine{80     logger.info(f\textcolor{stringliteral}{'avi\_file: \{avi\_file\}'})}
\DoxyCodeLine{81     logger.info(f\textcolor{stringliteral}{'avi\_date\_code: \{avi\_date\_code\}'})}
\DoxyCodeLine{82     logger.info(f\textcolor{stringliteral}{'avi\_segment\_scratch: \{avi\_segment\_scratch\}'})}
\DoxyCodeLine{83     logger.info(f\textcolor{stringliteral}{'seg\_output: \{seg\_output\}'})}
\DoxyCodeLine{84     logger.info(f\textcolor{stringliteral}{'segment\_dir: \{segment\_dir\}'})}
\DoxyCodeLine{85     logger.info(f\textcolor{stringliteral}{'working\_dir: \{working\_dir\}'})}
\DoxyCodeLine{86     logger.info(f\textcolor{stringliteral}{"{}Current ram usage (GB): \{psutil.virtual\_memory()[3]/1000000000:.2f\}"{}})}
\DoxyCodeLine{87     logger.info(f\textcolor{stringliteral}{"{}Current cpu usage (\%): \{psutil.cpu\_percent(4):.1f\}"{}})}
\DoxyCodeLine{88     }
\DoxyCodeLine{89 }
\DoxyCodeLine{90     logger.debug(f\textcolor{stringliteral}{'Starting AVI file: \{avi\_file\}'})}
\DoxyCodeLine{91 }
\DoxyCodeLine{92     \textcolor{comment}{\# Create necessary directory structure.}}
\DoxyCodeLine{93     logger.info(\textcolor{stringliteral}{'Setting up AVI directories.'})}
\DoxyCodeLine{94     os.makedirs(avi\_segment\_scratch, permis, exist\_ok=\textcolor{keyword}{True})}
\DoxyCodeLine{95     os.makedirs(seg\_output, permis, exist\_ok=\textcolor{keyword}{True})}
\DoxyCodeLine{96 }
\DoxyCodeLine{97     \textcolor{comment}{\# Segmentation.}}
\DoxyCodeLine{98     logger.info(\textcolor{stringliteral}{'Starting segmentation.'})}
\DoxyCodeLine{99     timer\_seg = time()}
\DoxyCodeLine{100     seg\_ff(avi, seg\_output, SNR, segment\_path)}
\DoxyCodeLine{101     timer\_seg = time() -\/ timer\_seg}
\DoxyCodeLine{102     logger.debug(f\textcolor{stringliteral}{"{}Segmentation executable took \{timer\_seg:.3f\} s."{}})}
\DoxyCodeLine{103 }
\DoxyCodeLine{104     \textcolor{keywordflow}{if} config[\textcolor{stringliteral}{'general'}][\textcolor{stringliteral}{'compress\_output'}] == \textcolor{stringliteral}{'True'}:}
\DoxyCodeLine{105         logger.info(\textcolor{stringliteral}{'Start tarring+compressing.'})}
\DoxyCodeLine{106         tar\_name = out\_dir + \textcolor{stringliteral}{"{}.tar.gz"{}}}
\DoxyCodeLine{107         tar = f\textcolor{stringliteral}{'tar czf \(\backslash\)"{}\{tar\_name\}\(\backslash\)"{} -\/C \(\backslash\)"{}\{seg\_output\}\(\backslash\)"{} .'}}
\DoxyCodeLine{108         logger.debug(tar)}
\DoxyCodeLine{109         }
\DoxyCodeLine{110         timer\_tar = time()}
\DoxyCodeLine{111         os.system(tar)}
\DoxyCodeLine{112         os.chmod(tar\_name, permis)}
\DoxyCodeLine{113         timer\_tar = time() -\/ timer\_tar}
\DoxyCodeLine{114 }
\DoxyCodeLine{115         logger.info(f\textcolor{stringliteral}{'End tarring+compressing in \{timer\_tar:.3f\} s.'})}
\DoxyCodeLine{116     \textcolor{keywordflow}{else}:}
\DoxyCodeLine{117         logger.info(\textcolor{stringliteral}{'Start tarring'})}
\DoxyCodeLine{118         tar\_name = out\_dir + \textcolor{stringliteral}{"{}.tar"{}}}
\DoxyCodeLine{119         tar = f\textcolor{stringliteral}{'tar cf \(\backslash\)"{}\{tar\_name\}\(\backslash\)"{} -\/C \(\backslash\)"{}\{seg\_output\}\(\backslash\)"{} .'}}
\DoxyCodeLine{120         logger.debug(tar)}
\DoxyCodeLine{121 }
\DoxyCodeLine{122         timer\_tar = time()}
\DoxyCodeLine{123         os.system(tar)}
\DoxyCodeLine{124         os.chmod(tar\_name, permis)}
\DoxyCodeLine{125         timer\_tar = time() -\/ timer\_tar}
\DoxyCodeLine{126 }
\DoxyCodeLine{127         logger.info(f\textcolor{stringliteral}{'End tarring in \{timer\_tar:.3f\} s.'})}
\DoxyCodeLine{128 }
\DoxyCodeLine{129     shutil.rmtree(seg\_output)          \textcolor{comment}{\# remove datecode\_s/}}
\DoxyCodeLine{130     shutil.rmtree(avi\_segment\_scratch) \textcolor{comment}{\# remove datecode/}}
\DoxyCodeLine{131     logger.info(\textcolor{stringliteral}{'End local\_main.'})}
\DoxyCodeLine{132 }
\DoxyCodeLine{133 }

\end{DoxyCode}
\mbox{\Hypertarget{namespacesegmentation_ad33a0fb68e616156cf9cf6fdd13f4a98}\label{namespacesegmentation_ad33a0fb68e616156cf9cf6fdd13f4a98}} 
\index{segmentation@{segmentation}!seg\_ff@{seg\_ff}}
\index{seg\_ff@{seg\_ff}!segmentation@{segmentation}}
\doxysubsubsection{\texorpdfstring{seg\_ff()}{seg\_ff()}}
{\footnotesize\ttfamily def segmentation.\+seg\+\_\+ff (\begin{DoxyParamCaption}\item[{}]{avi,  }\item[{}]{seg\+\_\+output,  }\item[{}]{SNR,  }\item[{}]{segment\+\_\+path }\end{DoxyParamCaption})}

\begin{DoxyVerb}Formats and calls the segmentation executable\end{DoxyVerb}
 

Definition at line 46 of file segmentation.\+py.


\begin{DoxyCode}{0}
\DoxyCodeLine{46 \textcolor{keyword}{def }seg\_ff(avi, seg\_output, SNR, segment\_path):}
\DoxyCodeLine{47     \textcolor{stringliteral}{"{}"{}"{}Formats and calls the segmentation executable"{}"{}"{}}}
\DoxyCodeLine{48     snr = str(SNR)}
\DoxyCodeLine{49     epsilon = config[\textcolor{stringliteral}{'segmentation'}][\textcolor{stringliteral}{'overlap'}]}
\DoxyCodeLine{50     delta = config[\textcolor{stringliteral}{'segmentation'}][\textcolor{stringliteral}{'delta'}]}
\DoxyCodeLine{51     max\_area = config[\textcolor{stringliteral}{'segmentation'}][\textcolor{stringliteral}{'max\_area'}]}
\DoxyCodeLine{52     min\_area = config[\textcolor{stringliteral}{'segmentation'}][\textcolor{stringliteral}{'min\_area'}]}
\DoxyCodeLine{53 }
\DoxyCodeLine{54     segment\_log = working\_dir + \textcolor{stringliteral}{'/segmentation/segment\_'} + str(datetime.datetime.now()) + \textcolor{stringliteral}{'.log'}}
\DoxyCodeLine{55     full\_output = config[\textcolor{stringliteral}{'segmentation'}][\textcolor{stringliteral}{'full\_output'}]}
\DoxyCodeLine{56 }
\DoxyCodeLine{57     seg = f\textcolor{stringliteral}{'nohup \(\backslash\)"{}\{segment\_path\}\(\backslash\)"{} -\/i \(\backslash\)"{}\{avi\}\(\backslash\)"{} -\/o \(\backslash\)"{}\{seg\_output\}\(\backslash\)"{} -\/s \{snr\} -\/e \{epsilon\} -\/M \{max\_area\} -\/m \{min\_area\} -\/d \{delta\} \{full\_output\} >> \(\backslash\)"{}\{segment\_log\}\(\backslash\)"{} 2>\&1'}}
\DoxyCodeLine{58     logger.info(\textcolor{stringliteral}{"{}Segmentation call: "{}} + seg)}
\DoxyCodeLine{59 }
\DoxyCodeLine{60     os.chmod(seg\_output, permis)}
\DoxyCodeLine{61 }
\DoxyCodeLine{62     timer\_seg = time()}
\DoxyCodeLine{63     os.system(seg)}
\DoxyCodeLine{64     timer\_seg = time() -\/ timer\_seg}
\DoxyCodeLine{65     logger.debug(f\textcolor{stringliteral}{"{}Segmentation finished in \{timer\_seg:.3f\} s."{}})}
\DoxyCodeLine{66 }
\DoxyCodeLine{67 }
\DoxyCodeLine{68 }

\end{DoxyCode}
